name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.2.3)'
        required: true
        type: string

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build for ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            executable_suffix: .exe
            archive_suffix: .zip
          - target: x86_64-apple-darwin
            os: macos-latest
            executable_suffix: ''
            archive_suffix: .tar.gz
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            executable_suffix: ''
            archive_suffix: .tar.gz

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Cache cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Build release binary
      run: cargo build --release --target ${{ matrix.target }}

    - name: Check FFmpeg (Windows)
      if: matrix.target == 'x86_64-pc-windows-msvc'
      shell: bash
      run: |
        if [[ ! -f "ffmpeg.exe" ]]; then
          echo "âš ï¸ ffmpeg.exe not found, downloading..."
          curl -L -o ffmpeg.zip "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip"
          7z x ffmpeg.zip
          cp ffmpeg-master-latest-win64-gpl/bin/ffmpeg.exe .
          rm -rf ffmpeg-master-latest-win64-gpl ffmpeg.zip
        else
          echo "âœ… ffmpeg.exe found"
        fi

    - name: Prepare release directory
      shell: bash
      run: |
        mkdir -p release
        cp target/${{ matrix.target }}/release/video-gif${{ matrix.executable_suffix }} release/
        cp README.MD release/
        cp LICENSE release/
        
        # Copy platform-specific files
        if [[ "${{ matrix.target }}" == "x86_64-pc-windows-msvc" ]]; then
          cp video-gif.bat release/
          cp ffmpeg.exe release/
        elif [[ "${{ matrix.target }}" == "x86_64-apple-darwin" ]]; then
          # For macOS, create a script that assumes ffmpeg is in PATH
          cat > release/install-ffmpeg.sh << 'EOF'
        #!/bin/bash
        echo "æ­£åœ¨æ£€æŸ¥FFmpeg..."
        if ! command -v ffmpeg &> /dev/null; then
            echo "è¯·å®‰è£…FFmpeg: brew install ffmpeg"
            exit 1
        fi
        echo "FFmpegå·²å®‰è£…ï¼Œå¯ä»¥ä½¿ç”¨video-gifå·¥å…·"
        EOF
          chmod +x release/install-ffmpeg.sh
        elif [[ "${{ matrix.target }}" == "x86_64-unknown-linux-gnu" ]]; then
          # For Linux, create a script that assumes ffmpeg is in PATH  
          cat > release/install-ffmpeg.sh << 'EOF'
        #!/bin/bash
        echo "æ­£åœ¨æ£€æŸ¥FFmpeg..."
        if ! command -v ffmpeg &> /dev/null; then
            echo "è¯·å®‰è£…FFmpeg:"
            echo "Ubuntu/Debian: sudo apt-get install ffmpeg"
            echo "CentOS/RHEL: sudo yum install ffmpeg"
            echo "Arch Linux: sudo pacman -S ffmpeg"
            exit 1
        fi
        echo "FFmpegå·²å®‰è£…ï¼Œå¯ä»¥ä½¿ç”¨video-gifå·¥å…·"
        EOF
          chmod +x release/install-ffmpeg.sh
        fi

    - name: Create archive (Windows)
      if: matrix.os == 'windows-latest'
      shell: bash
      run: |
        cd release
        7z a ../video-gif-${{ matrix.target }}${{ matrix.archive_suffix }} *

    - name: Create archive (Unix)
      if: matrix.os != 'windows-latest'
      shell: bash
      run: |
        cd release
        tar -czf ../video-gif-${{ matrix.target }}${{ matrix.archive_suffix }} *

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: video-gif-${{ matrix.target }}
        path: video-gif-${{ matrix.target }}${{ matrix.archive_suffix }}

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Generate release tag
      id: tag
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
        else
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: Extract version from Cargo.toml
      id: version
      run: |
        VERSION=$(grep '^version = ' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Generate changelog
      id: changelog
      run: |
        # Extract changelog for current version from README.MD
        VERSION="${{ steps.version.outputs.version }}"
        
        # Create changelog from README
        cat > CHANGELOG.md << 'EOF'
        # Video to GIF è½¬æ¢å·¥å…· - Release ${{ steps.tag.outputs.tag }}
        
        ## ðŸŽ‰ æ–°ç‰ˆæœ¬å‘å¸ƒï¼šv${{ steps.version.outputs.version }}
        
        ### ðŸ“¥ ä¸‹è½½è¯´æ˜Ž
        
        è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿä¸‹è½½å¯¹åº”çš„æ–‡ä»¶ï¼š
        
        - **Windows ç”¨æˆ·**: `video-gif-x86_64-pc-windows-msvc.zip`
        - **macOS ç”¨æˆ·**: `video-gif-x86_64-apple-darwin.tar.gz`  
        - **Linux ç”¨æˆ·**: `video-gif-x86_64-unknown-linux-gnu.tar.gz`
        
        ### ðŸš€ ä½¿ç”¨æ–¹æ³•
        
        1. ä¸‹è½½å¯¹åº”å¹³å°çš„åŽ‹ç¼©åŒ…
        2. è§£åŽ‹åˆ°ä»»æ„ç›®å½•
        3. Windowsç”¨æˆ·ï¼šå°†æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹æ‹–æ‹½åˆ° `video-gif.bat` ä¸Š
        4. macOS/Linuxç”¨æˆ·ï¼šåœ¨ç»ˆç«¯ä¸­è¿è¡Œ `./video-gif <æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹è·¯å¾„>`
        
        ### âœ¨ ä¸»è¦åŠŸèƒ½
        
        - ðŸŽ¬ æ”¯æŒå•ä¸ªMP4æ–‡ä»¶è½¬æ¢
        - ðŸ“ æ”¯æŒæ‰¹é‡æ–‡ä»¶å¤¹å¤„ç†
        - ðŸ–±ï¸ Windowsæ‹–æ‹½æ”¯æŒ
        - âš¡ å†…ç½®FFmpegï¼Œæ— éœ€é¢å¤–å®‰è£…
        - ðŸŒ å®Œå…¨æ”¯æŒä¸­æ–‡è·¯å¾„å’Œç‰¹æ®Šå­—ç¬¦
        
        ### ðŸ”§ æŠ€æœ¯ç‰¹æ€§
        
        - åŸºäºŽRustå¼€å‘ï¼Œæ€§èƒ½ä¼˜å¼‚
        - è·¨å¹³å°æ”¯æŒï¼ˆWindows/macOS/Linuxï¼‰
        - æ™ºèƒ½é”™è¯¯å¤„ç†
        - è¿›åº¦æ¡æ˜¾ç¤º
        - å¯è‡ªå®šä¹‰è¾“å‡ºå‚æ•°
        EOF
        
        # Extract current version changes from README if available
        if grep -q "### v${{ steps.version.outputs.version }}" README.MD; then
          echo "" >> CHANGELOG.md
          echo "### ðŸ“‹ æœ¬ç‰ˆæœ¬æ›´æ–°å†…å®¹" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          sed -n "/### v${{ steps.version.outputs.version }}/,/### v/p" README.MD | head -n -1 | tail -n +2 >> CHANGELOG.md
        fi
        
        echo "" >> CHANGELOG.md
        echo "---" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "**å®Œæ•´æ›´æ–°æ—¥å¿—**: [æŸ¥çœ‹README.MD](https://github.com/${{ github.repository }}/blob/main/README.MD#æ›´æ–°æ—¥å¿—)" >> CHANGELOG.md

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: "Release ${{ steps.tag.outputs.tag }}"
        body_path: CHANGELOG.md
        draft: false
        prerelease: false
        files: |
          artifacts/video-gif-x86_64-pc-windows-msvc/video-gif-x86_64-pc-windows-msvc.zip
          artifacts/video-gif-x86_64-apple-darwin/video-gif-x86_64-apple-darwin.tar.gz
          artifacts/video-gif-x86_64-unknown-linux-gnu/video-gif-x86_64-unknown-linux-gnu.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Update latest release info
      run: |
        echo "âœ… Release ${{ steps.tag.outputs.tag }} created successfully!"
        echo "ðŸ“¦ Artifacts uploaded:"
        echo "  - Windows: video-gif-x86_64-pc-windows-msvc.zip"
        echo "  - macOS: video-gif-x86_64-apple-darwin.tar.gz" 
        echo "  - Linux: video-gif-x86_64-unknown-linux-gnu.tar.gz" 